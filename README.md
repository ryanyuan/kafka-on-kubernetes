# Apache Kafka on Kubernetes

This project enables deployment of a [Kafka](http://kafka.apache.org/) cluster using
[Kubernetes](http://kubernetes.io/) with [Zookeeper](https://zookeeper.apache.org/).

# Prerequisite

You need to have a Kubernetes cluster running and the [kubect CLI tool](https://kubernetes.io/docs/tasks/tools/install-kubectl/) in your path.

# Step-by-step

Given that Kafka depends on [Zookeeper](https://zookeeper.apache.org/) for
[reasons](https://www.quora.com/What-is-the-actual-role-of-ZooKeeper-in-Kafka),
we need to deploy Zookeeper before we create the Kafka cluster. 
We launch three distinct deployments to specify the Zookeeper ID of each
instance and to list all brokers in the pool. As of now, we are unable to use a
single deployment with three Zookeeper instances. Even worse, we need to use
three distinct services as well.

```
$ kubectl create -f zookeeper-services.yml
$ kubectl create -f zookeeper-deployment.yml
```

After the Zookeeper cluster is launched, check that all three deployments are
`Running`.

```
$ kubectl get pods
NAME                    READY     STATUS    RESTARTS   AGE
zk-0-86c6b88498-z7g2z   1/1       Running   0          23s
zk-1-56bbbdc769-ndfkb   1/1       Running   0          23s
zk-2-7549c49f5b-4d9rl   1/1       Running   0          23s
```

One of the zookeeper deployments should be `LEADING`, while the other two zookeeper controllers should be
`FOLLOWERS`. To check that, look at the pod logs.

```
$ kubectl logs zk-2-7549c49f5b-4d9rl
...
2018-07-20 07:11:56,389 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2181:Leader@371] - LEADING - LEADER ELECTION TOOK - 10863
```

Next, let's create the Kafka service behind a load balancer.

```
$ kubectl create -f kafka-service.yml
```

At this point, we need to set the `KAFKA_ADVERTISED_HOST_NAME` in
`kafka-deployment.yml` before deploy the Kafka brokers. You can use either a
custom DNS name or one generated by your cloud provider. To see the DNS name, type:

```
$ kubectl describe service kafka-service
Name:              kafka-service
...
LoadBalancer Ingress:     123.123.123.123
...
Events:
  Type    Reason                Age   From                Message
  ----    ------                ----  ----                -------
  Normal  EnsuringLoadBalancer  57s   service-controller  Ensuring load balancer
  Normal  EnsuredLoadBalancer   4s    service-controller  Ensured load balancer
```

If you can't see the key/value pair of LoadBalancer Ingress, you may need to wait a couple of minutes because the load balancer is being created.

After you copy/pasta the entry next to `LoadBalancer Ingress` to
`KAFKA_ADVERTISED_HOST_NAME` in `kafka-deployment.yml`, we are finally ready to
create the Kafka cluster:

```
$ kubectl create -f kafka-deployment.yml
```

If you wish to create a topic at deployment time, add a key
`KAFKA_CREATE_TOPICS` to the environment variables with the topic name. For
instance, the following environment variable creates the topic `mytopic` with
2 partitions and 1 replica:

```
env:
- name: KAFKA_CREATE_TOPICS
value: mytopic:2:1
```

Congrats! You have a working Kafka cluster running on Kubernetes. Next, a useful way to test your setup is via
[`kafkacat`](https://github.com/edenhill/kafkacat). Once installed, you can be a pushlisher to
publish messages to Kafka using the Kafka hostname from above:

```
kafkacat -P -b 123.123.123.123:9092 -t mytopic
```

And then to be a consumer to listen to it, type:

```
kafkacat -C -b 123.123.123.123:9092 -t mytopic
```